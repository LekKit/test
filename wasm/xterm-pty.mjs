var h=class{constructor(){this.listeners=new Set;this.register=this._register.bind(this)}_register(e){return this.listeners.add(e),{dispose:()=>{this.listeners.delete(e)}}}fire(e){for(let i of this.listeners)try{i(e)}catch(r){console.error(r)}}};var P=o=>48<=o&&o<=57||65<=o&&o<=90||o==95||97<=o&&o<=122,T=o=>0<=o&&o<=31&&o!=9||o==127,E=o=>(o&192)==128,x=o=>65<=o&&o<=90?o+32:o,R=o=>97<=o&&o<=122?o-32:o,N=new TextEncoder,p=o=>Array.from(N.encode(o));var V=(t=>(t[t.ISTRIP=32]="ISTRIP",t[t.INLCR=64]="INLCR",t[t.IGNCR=128]="IGNCR",t[t.ICRNL=256]="ICRNL",t[t.IUCLC=512]="IUCLC",t[t.IXON=1024]="IXON",t[t.IXANY=2048]="IXANY",t[t.IMAXBEL=8192]="IMAXBEL",t[t.IUTF8=16384]="IUTF8",t[t.OPOST=1]="OPOST",t[t.OLCUC=2]="OLCUC",t[t.ONLCR=4]="ONLCR",t[t.OCRNL=8]="OCRNL",t[t.ONOCR=16]="ONOCR",t[t.ONLRET=32]="ONLRET",t[t.TABDLY=6144]="TABDLY",t[t.XTABS=6144]="XTABS",t[t.ISIG=1]="ISIG",t[t.ICANON=2]="ICANON",t[t.ECHO=8]="ECHO",t[t.ECHOE=16]="ECHOE",t[t.ECHOK=32]="ECHOK",t[t.ECHONL=64]="ECHONL",t[t.NOFLSH=128]="NOFLSH",t[t.ECHOCTL=512]="ECHOCTL",t[t.ECHOPRT=1024]="ECHOPRT",t[t.ECHOKE=2048]="ECHOKE",t[t.IEXTEN=32768]="IEXTEN",t[t.VINTR=0]="VINTR",t[t.VQUIT=1]="VQUIT",t[t.VERASE=2]="VERASE",t[t.VKILL=3]="VKILL",t[t.VEOF=4]="VEOF",t[t.VTIME=5]="VTIME",t[t.VMIN=6]="VMIN",t[t.VSWTCH=7]="VSWTCH",t[t.VSTART=8]="VSTART",t[t.VSTOP=9]="VSTOP",t[t.VSUSP=10]="VSUSP",t[t.VEOL=11]="VEOL",t[t.VREPRINT=12]="VREPRINT",t[t.VDISCARD=13]="VDISCARD",t[t.VWERASE=14]="VWERASE",t[t.VLNEXT=15]="VLNEXT",t[t.VEOL2=16]="VEOL2",t))(V||{}),f=class o{constructor(e,i,r,s,L){this.iflag=e;this.oflag=i;this.cflag=r;this.lflag=s;this.cc=L;this.ISTRIP_P=(this.iflag&32)!=0;this.INLCR_P=(this.iflag&64)!=0;this.IGNCR_P=(this.iflag&128)!=0;this.ICRNL_P=(this.iflag&256)!=0;this.IUCLC_P=(this.iflag&512)!=0;this.IXON_P=(this.iflag&1024)!=0;this.IXANY_P=(this.iflag&2048)!=0;this.IUTF8_P=(this.iflag&16384)!=0;this.OPOST_P=(this.oflag&1)!=0;this.OLCUC_P=(this.oflag&2)!=0;this.ONLCR_P=(this.oflag&4)!=0;this.OCRNL_P=(this.oflag&8)!=0;this.ONOCR_P=(this.oflag&16)!=0;this.ONLRET_P=(this.oflag&32)!=0;this.TABDLY_XTABS_P=(this.oflag&6144)==6144;this.ISIG_P=(this.lflag&1)!=0;this.ICANON_P=(this.lflag&2)!=0;this.ECHO_P=(this.lflag&8)!=0;this.ECHOE_P=(this.lflag&16)!=0;this.ECHOK_P=(this.lflag&32)!=0;this.ECHONL_P=(this.lflag&64)!=0;this.NOFLSH_P=(this.lflag&128)!=0;this.ECHOCTL_P=(this.lflag&512)!=0;this.ECHOPRT_P=(this.lflag&1024)!=0;this.ECHOKE_P=(this.lflag&2048)!=0;this.IEXTEN_P=(this.lflag&32768)!=0;this.INTR_V=this.cc[0];this.QUIT_V=this.cc[1];this.ERASE_V=this.cc[2];this.KILL_V=this.cc[3];this.EOF_V=this.cc[4];this.TIME_V=this.cc[5];this.MIN_V=this.cc[6];this.SWTCH_V=this.cc[7];this.START_V=this.cc[8];this.STOP_V=this.cc[9];this.SUSP_V=this.cc[10];this.EOL_V=this.cc[11];this.REPRINT_V=this.cc[12];this.DISCARD_V=this.cc[13];this.WERASE_V=this.cc[14];this.LNEXT_V=this.cc[15];this.EOL2_V=this.cc[16]}static fromConfig(e){return new o(e.iflag,e.oflag,e.cflag,e.lflag,e.cc)}clone(){return o.fromConfig(this)}},w=new f(25856,5,191,35387,[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);var d=class{constructor(){this._onWriteToLower=new h;this.onWriteToLower=this._onWriteToLower.register;this._onWriteToUpper=new h;this.onWriteToUpper=this._onWriteToUpper.register;this._onSignalToUpper=new h;this.onSignalToUpper=this._onSignalToUpper.register;this._onFlowActivated=new h;this.onFlowActivated=this._onFlowActivated.register;this._onFlowDeactivated=new h;this.onFlowDeactivated=this._onFlowDeactivated.register;this.T=w;this.keyActions=new Array(256).fill("normal");this.flowActivated=!0;this.column=0;this.baseColumn=0;this.vlnext=!1;this.echoprt=!1;this.toLowerBuf=[];this.toUpperBuf=[];this.termios=w}activateFlow(){this.flowActivated=!0,this._onFlowActivated.fire()}deactivateFlow(){this.flowActivated=!1,this._onFlowDeactivated.fire()}get flow(){return this.flowActivated}get termios(){return this.T}set termios(e){this.T=e;let i=new Array(256).fill("normal");e.ICANON_P&&(i[e.EOF_V]="VEOF",i[e.EOL_V]="VEOL",i[e.EOL2_V]="VEOL",i[e.ERASE_V]="VERASE",i[e.KILL_V]="VKILL",e.IEXTEN_P&&(i[e.REPRINT_V]="VREPRINT",i[e.WERASE_V]="VWERASE")),e.IEXTEN_P&&(i[e.LNEXT_V]="VLNEXT"),e.IXON_P&&(i[e.START_V]="VSTART",i[e.STOP_V]="VSTOP"),e.ISIG_P&&(i[e.INTR_V]="VINTR",i[e.QUIT_V]="VQUIT",i[e.SUSP_V]="VSUSP"),i[0]="normal",this.keyActions=i,this.T.IXON_P||(this.activateFlow(),this.flushToLower())}clearToLower(){this.toLowerBuf.length=0}flushToLower(){this.flowActivated!=!1&&(this._onWriteToLower.fire(this.toLowerBuf),this.clearToLower())}outputToLower(e){this.toLowerBuf.push(...e)}updateBaseColumn(){this.toUpperBuf.length==0&&(this.baseColumn=this.column)}clearToUpper(){this.toUpperBuf.length=0,this.updateBaseColumn()}flushToUpper(){this._onWriteToUpper.fire(this.toUpperBuf),this.clearToUpper()}outputToUpper(e){this.toUpperBuf.push(e)}outputToLowerWithPostprocess(e){if(this.T.OPOST_P)switch(e){case 8:this.column>0&&this.column--,this.outputToLower([8]);break;case 9:{let i=8-this.column%8;this.column+=i,this.outputToLower(this.T.TABDLY_XTABS_P?new Array(i).fill(32):[9]);break}case 10:this.T.ONLCR_P?(this.baseColumn=this.column=0,this.outputToLower([13,10])):this.T.ONLRET_P?(this.column=0,this.outputToLower([10])):(this.baseColumn=this.column,this.outputToLower([10]));break;case 13:this.T.ONOCR_P&&this.column==0||(this.T.OCRNL_P?(this.T.ONLRET_P&&(this.baseColumn=this.column=0),this.outputToLower([10])):(this.baseColumn=this.column=0,this.outputToLower([13])));break;default:this.T.IUTF8_P&&E(e)||this.column++,this.outputToLower(this.T.OLCUC_P?[R(e)]:[e]);break}else this.outputToLower([e])}echoToLower(e,i){typeof e=="number"&&(e=[e]);for(let r of e)this.T.ECHOCTL_P&&T(r)&&r!=9&&!i?(this.outputToLower([94,r^64]),this.column+=2):this.outputToLowerWithPostprocess(r)}inputFromLowerWithPreprocess(e){if(e==13){if(this.T.IGNCR_P)return;this.T.ICRNL_P&&(e=10)}else e==10&&this.T.INLCR_P&&(e=13);this.T.ICANON_P&&e==10?((this.T.ECHO_P||this.T.ECHONL_P)&&(this.echoToLower(10,!0),this.flushToLower()),this.outputToUpper(10),this.flushToUpper()):this.T.ECHO_P?(this.finishECHOPRT(),this.updateBaseColumn(),e==10?this.echoToLower(10,!0):this.echoToLower(e),this.flushToLower(),this.outputToUpper(e)):this.outputToUpper(e)}erase(e){if(this.toUpperBuf.length==0)return;if(e=="VKILL"){if(!this.T.ECHO_P){this.clearToUpper();return}if(!this.T.ECHOK_P||!this.T.ECHOKE_P||!this.T.ECHOE_P){this.clearToUpper(),this.finishECHOPRT(),this.echoToLower(this.T.KILL_V),this.T.ECHOK_P&&this.echoToLower(10,!0);return}}let i=!1;for(let r=this.toUpperBuf.length-1;r>=0;r--){let s=this.toUpperBuf[r];if(this.T.IUTF8_P&&E(s))continue;if(e=="VWERASE"){if(P(s)||s==95)i=!0;else if(i)break}let L=this.toUpperBuf.splice(r);if(this.T.ECHO_P)if(this.T.ECHOPRT_P)this.startECHOPRT(),this.echoToLower(L);else if(e=="VERASE"&&!this.T.ECHOE_P)this.echoToLower(this.T.ERASE_V);else if(s==9){let a=0,S=!1;for(let m=this.toUpperBuf.length-1;m>=0;m--){let C=this.toUpperBuf[m];if(C==9){S=!0;break}else T(C)?this.T.ECHOCTL_P&&(a+=2):this.T.IUTF8_P&&E(C)||a++}S||(a+=this.baseColumn),a=8-a%8,this.outputToLower(new Array(a).fill(8)),this.column=Math.max(0,this.column-a)}else T(s)&&this.T.ECHOCTL_P&&this.echoToLower([8,32,8],!0),(!T(s)||this.T.ECHOCTL_P)&&this.echoToLower([8,32,8],!0);if(e=="VERASE")break}this.toUpperBuf.length==0&&(this.clearToUpper(),this.T.ECHO_P&&this.finishECHOPRT())}startECHOPRT(){this.echoprt||(this.echoToLower(92,!0),this.echoprt=!0)}finishECHOPRT(){this.echoprt&&(this.echoToLower(47,!0),this.echoprt=!1)}signal(e,i){this._onSignalToUpper.fire(e),this.T.NOFLSH_P||(this.clearToLower(),this.clearToUpper()),this.T.IXON_P&&this.activateFlow(),this.T.ECHO_P&&this.echoToLower(i),this.flushToLower()}checkStartFlow(){this.flowActivated==!1&&this.T.IXON_P&&this.T.IXANY_P&&(this.activateFlow(),this.flushToLower())}nextLiteral(){this.vlnext=!0,this.T.ECHO_P&&(this.finishECHOPRT(),this.T.ECHOCTL_P&&(this.echoToLower([94,8],!0),this.flushToLower()))}reprint(){this.finishECHOPRT(),this.echoToLower(this.T.REPRINT_V),this.echoToLower(10,!0),this.echoToLower(this.toUpperBuf)}writeFromLower(e){let i=typeof e=="string"?p(e):e;for(let r of i){this.T.ISTRIP_P&&(r&=127),this.T.IUCLC_P&&this.T.IEXTEN_P&&(r=x(r));let s=this.vlnext?"normal":this.keyActions[r];switch(this.vlnext=!1,s){case"normal":this.checkStartFlow(),this.inputFromLowerWithPreprocess(r);break;case"VERASE":case"VWERASE":case"VKILL":this.checkStartFlow(),this.erase(s),this.flushToLower();break;case"VEOF":this.checkStartFlow(),this.flushToUpper();break;case"VEOL":this.checkStartFlow(),this.T.ECHO_P&&(this.echoToLower(r),this.flushToLower()),this.outputToUpper(r),this.flushToUpper();break;case"VLNEXT":this.checkStartFlow(),this.nextLiteral();break;case"VREPRINT":this.checkStartFlow(),this.reprint(),this.flushToLower();break;case"VSTART":this.activateFlow(),this.flushToLower();break;case"VSTOP":this.deactivateFlow();break;case"VINTR":this.signal("SIGINT",r);break;case"VQUIT":this.signal("SIGQUIT",r);break;case"VSUSP":this.signal("SIGTSTP",r);break}}this.T.ICANON_P||this.flushToUpper()}writeFromUpper(e){if(this.flowActivated==!1)throw"Do not write anything during flowStatus is stopped";let i=typeof e=="string"?p(e):e;for(let r of i)this.outputToLowerWithPostprocess(r);this.flushToLower()}};var y=4096,_=class{constructor(e,i){this.ldisc=e;this.slave=i;this.disposables=[];this._onWrite=new h;this.onWrite=this._onWrite.register;this.fromLdiscToLowerBuffer=[];this.waitingForLower=!1;let r=()=>{if(this.fromLdiscToLowerBuffer.length>=1){this.waitingForLower=!0;let a=new Uint8Array(this.fromLdiscToLowerBuffer.splice(0,4096));this.fromLdiscToLowerBuffer.length<=y&&this.notifyWritable(),this._onWrite.fire([a,r])}else this.waitingForLower=!1};this.ldisc.onWriteToLower(a=>{this.fromLdiscToLowerBuffer.push(...a),this.waitingForLower||r()});let{notifyWritable:s,notifyResize:L}=i.initFromMaster();this.notifyWritable=s,this.notifyResize=L}activate(e){this.onWrite(([r,s])=>e.write(r,s));let i=r=>this.ldisc.writeFromLower(r);this.disposables.push(e.onData(i),e.onBinary(i),e.onResize(({cols:r,rows:s})=>this.notifyResize(s,r)))}dispose(){this.disposables.forEach(e=>e.dispose()),this.disposables.length=0}},I=class{constructor(e){this.ldisc=e;this._onReadable=new h;this.onReadable=this._onReadable.register;this._onWritable=new h;this.onWritable=this._onWritable.register;this._onSignal=new h;this.onSignal=this._onSignal.register;this.fromLdiscToUpperBuffer=[];this.fromUpperToLdiscBuffer=[];this.winsize=[80,24];this.ldisc.onWriteToUpper(i=>{this.fromLdiscToUpperBuffer.push(...i),this._onReadable.fire()}),this.ldisc.onFlowActivated(()=>{this.fromUpperToLdiscBuffer.length>=1&&(this.ldisc.writeFromUpper(this.fromUpperToLdiscBuffer),this.fromUpperToLdiscBuffer.length=0)}),this.ldisc.onSignalToUpper(i=>{this._onSignal.fire(i)})}initFromMaster(){return{notifyWritable:()=>this._onWritable.fire(),notifyResize:(e,i)=>{this.winsize=[i,e],this._onSignal.fire("SIGWINCH")}}}get readable(){return this.fromLdiscToUpperBuffer.length>=1}read(e){let i=typeof e!="undefined"?Math.min(this.fromLdiscToUpperBuffer.length,e):this.fromLdiscToUpperBuffer.length;return this.fromLdiscToUpperBuffer.splice(0,i)}get writable(){return this.fromUpperToLdiscBuffer.length<=y}write(e){let i=typeof e=="string"?p(e):e;this.fromUpperToLdiscBuffer=this.fromUpperToLdiscBuffer.concat(i),this.ldisc.flow&&(this.ldisc.writeFromUpper(this.fromUpperToLdiscBuffer),this.fromUpperToLdiscBuffer.length=0)}ioctl(e,i){switch(e){case"TCGETS":return this.ldisc.termios.clone();case"TCSETS":if(!i)throw new Error("ioctl: TCSETS requires a TermiosConfig");this.ldisc.termios=f.fromConfig(i);return;case"TIOCGWINSZ":return this.winsize.slice()}}},b=()=>{let o=new d,e=new I(o);return{master:new _(o,e),slave:e}};export{V as Flags,f as Termios,b as openpty};
//# sourceMappingURL=index.mjs.map